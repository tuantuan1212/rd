local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local replicatedStorage = game:GetService("ReplicatedStorage")
local tweenService = game:GetService("TweenService")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Smooth movement function
local function flyToPositionSmooth(position, speed, callback)
    if character and humanoidRootPart then
        local startPosition = humanoidRootPart.Position
        local distance = (position - startPosition).Magnitude
        local travelTime = distance / speed
        local startTime = tick()

        -- Move the character based on time rather than iteration count
        local connection
        connection = game:GetService("RunService").Heartbeat:Connect(function()
            local elapsedTime = tick() - startTime
            if elapsedTime < travelTime then
                local progress = elapsedTime / travelTime
                humanoidRootPart.CFrame = CFrame.new(startPosition:Lerp(position, progress))
            else
                -- Ensure exact position after travel time
                humanoidRootPart.CFrame = CFrame.new(position)
                connection:Disconnect()
                if callback then
                    callback()
                end
            end
        end)
    else
        warn("HumanoidRootPart not found or Character not loaded.")
    end
end

-- Điểm bắt đầu
local startPosition = CFrame.new(-474.928925, 150.898499, 312.700775)

-- Các hàm khác
local function RandomAction()
    local success, err = pcall(function()
        if replicatedStorage:FindFirstChild("Remotes") and replicatedStorage.Remotes:FindFirstChild("CommF_") then
            replicatedStorage.Remotes.CommF_:InvokeServer("Cousin", "Buy")
        else
            warn("CommF_ remote not found.")
        end
    end)
    if not success then
        warn("Error during RandomAction:", err)
    end
end

local function DropMultipleItemsFromBackpack(quantity)
    local success, err = pcall(function()
        for _, tool in ipairs(player.Backpack:GetChildren()) do
            if tool:IsA("Tool") then
                tool.Parent = player.Character
                local toolInCharacter = player.Character:FindFirstChild(tool.Name)
                if toolInCharacter then
                    toolInCharacter.Parent = game.Workspace
                end
            end
        end
    end)
    if not success then
        warn("Error during DropMultipleItemsFromBackpack:", err)
    end
end

local function UnequipTools()
    local success, err = pcall(function()
        for _, tool in ipairs(player.Character:GetChildren()) do
            if tool:IsA("Tool") then
                tool.Parent = player.Backpack
            end
        end
    end)
    if not success then
        warn("Error during UnequipTools:", err)
    end
end

-- Thực hiện các hành động
SetTeam("Pirates")
wait(1)
TravelToDressrosa()
flyToPositionSmooth(startPosition.Position, 200, function()
    -- Callback function once movement is complete
    RandomAction()
    UnequipTools()
    DropMultipleItemsFromBackpack(200)
end)

while true do
    wait(1)
    local success, errorMessage = pcall(function()
        flyToPositionSmooth(startPosition.Position, 200)
    end)
    if not success then
        warn("Error during flyToPositionSmooth:", errorMessage)
    end
    
    wait(1)
    RandomAction()
    wait(1)
    UnequipTools()
    wait(1)
    DropMultipleItemsFromBackpack(200)
    wait(1)
end
