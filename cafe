local player = game.Players.LocalPlayer
local replicatedStorage = game:GetService("ReplicatedStorage")
local runService = game:GetService("RunService")

-- Hàm thay đổi đội
local function SetTeam(teamName)
    replicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", teamName)
end

-- Hàm di chuyển đến vị trí với hiệu ứng mượt mà
local function flyToPositionSmooth(destination, speed, callback)
    local humanoidRootPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then
        warn("HumanoidRootPart not found. Character may not be loaded.")
        return
    end

    local startPosition = humanoidRootPart.Position
    local distance = (destination.Position - startPosition).Magnitude
    if distance == 0 then
        warn("Start and destination positions are the same. No movement needed.")
        return
    end

    local travelTime = distance / speed
    if travelTime <= 0 then
        warn("Invalid travelTime calculated. Speed may be too high.")
        return
    end

    local startTime = tick()

    local connection
    connection = runService.Heartbeat:Connect(function()
        local elapsedTime = tick() - startTime
        if elapsedTime < travelTime then
            local progress = elapsedTime / travelTime
            humanoidRootPart.CFrame = CFrame.new(startPosition:Lerp(destination.Position, progress))
        else
            humanoidRootPart.CFrame = destination
            connection:Disconnect()
            if callback then
                callback()
            end
        end
    end)
end

-- Hàm thực hiện hành động ngẫu nhiên
local function RandomAction()
    local success, result = pcall(function()
        return replicatedStorage.Remotes.CommF_:InvokeServer("Cousin", "Buy")
    end)

    if not success then
        warn("Error during RandomAction:", result)
    end
end

-- Hàm thả nhiều đồ từ ba lô
local function DropMultipleItemsFromBackpack(quantity)
    local count = 0
    for _, tool in ipairs(player.Backpack:GetChildren()) do
        if tool:IsA("Tool") and count < quantity then
            tool.Parent = player.Character
            local toolInCharacter = player.Character:FindFirstChild(tool.Name)
            if toolInCharacter then
                toolInCharacter.Parent = game.Workspace
            end
            count = count + 1
        end
    end
end

-- Hàm gỡ bỏ công cụ
local function UnequipTools()
    for _, tool in ipairs(player.Character:GetChildren()) do
        if tool:IsA("Tool") then
            tool.Parent = player.Backpack
        end
    end
end

-- Hàm reset stats
local function ResetStats()
    local args = {
        [1] = "BlackbeardReward",
        [2] = "Refund",
        [3] = "2"
    }

    local success, result = pcall(function()
        return replicatedStorage.Remotes.CommF_:InvokeServer(unpack(args))
    end)

    if not success then
        warn("Error during ResetStats:", result)
    end
end

-- Hàm gói dịch chuyển đến Dressrosa
local function TravelToDressrosa()
    local success, result = pcall(function()
        return replicatedStorage.Remotes.CommF_:InvokeServer("TravelDressrosa")
    end)

    if not success then
        warn("Error during TravelToDressrosa:", result)
    end
end

-- Vị trí bắt đầu
local startPosition = CFrame.new(-391.223541, 151.14415, 381.626801, -0.996948361, 0.00316949282, 0.0780005008, -1.28056854e-08, 0.999175429, -0.0406005718, -0.0780648738, -0.0404766612, -0.996126115)

-- Thực hiện các hành động
SetTeam("Pirates")
wait(1)
TravelToDressrosa()

flyToPositionSmooth(startPosition, 200, function()
    local success, errorMessage = pcall(function()
        flyToPositionSmooth(startPosition, 200)
    end)

    if not success then
        warn("Error during flyToPositionSmooth:", errorMessage)
    end

    -- Sau khi bay đến vị trí đầu tiên, thiết lập điểm spawn
    local args = {
        [1] = "SetSpawnPoint"
    }
    game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("CommF_"):InvokeServer(unpack(args))

    wait(1)

    -- Gọi hàm reset stats chỉ một lần
    -- ResetStats()

    -- RandomAction()
    -- UnequipTools()
    -- DropMultipleItemsFromBackpack(200)

    wait(1)
    while true do
        replicatedStorage.Remotes.CommF_:InvokeServer("EnablePvp")
        local newPosition = CFrame.new(-180.851715, 151.338257, -271.671143, 0.743322313, -0.0261673555, -0.668421447, -8.11414793e-08, 0.999234617, -0.0391181037, 0.668933392, 0.0290774107, 0.742753386)
        flyToPositionSmooth(newPosition, 200)
        wait(2)
    end
end)
