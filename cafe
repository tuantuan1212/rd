local player = game.Players.LocalPlayer
local replicatedStorage = game:GetService("ReplicatedStorage")
local runService = game:GetService("RunService")

-- Biến đếm số lần chết
local deathCount = 0
local maxDeaths = 3
local stopAfterMaxDeathsAtSecondPosition = false
local isFlying = false

-- Hàm thay đổi đội
local function SetTeam(teamName)
    replicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", teamName)
end

-- Hàm di chuyển đến vị trí với hiệu ứng mượt mà
local function flyToPositionSmooth(destination, speed, callback)
    local humanoidRootPart = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then
        warn("HumanoidRootPart not found. Character may not be loaded.")
        return
    end

    local startPosition = humanoidRootPart.Position
    local distance = (destination.Position - startPosition).Magnitude
    if distance == 0 then
        warn("Start and destination positions are the same. No movement needed.")
        return
    end

    local travelTime = distance / speed
    if travelTime <= 0 then
        warn("Invalid travelTime calculated. Speed may be too high.")
        return
    end

    local startTime = tick()

    local connection
    connection = runService.Heartbeat:Connect(function()
        if not isFlying then
            connection:Disconnect() -- Ngắt kết nối nếu không bay nữa
            return
        end

        local elapsedTime = tick() - startTime
        if elapsedTime < travelTime then
            local progress = elapsedTime / travelTime
            humanoidRootPart.CFrame = CFrame.new(startPosition:Lerp(destination.Position, progress))
        else
            humanoidRootPart.CFrame = destination
            connection:Disconnect()
            if callback then
                callback()
            end
        end
    end)
end

-- Gọi phương thức TravelDressrosaa
local function TravelToDressrosa()
    local success, result = pcall(function()
        return replicatedStorage.Remotes.CommF_:InvokeServer("TravelDressrosa")
    end)

    if not success then
        warn("Error during TravelToDressrosa:", result)
    end
end

-- Các vị trí cần di chuyển
local positions = {
    CFrame.new(-180.851715, 151.338257, -271.671143),
    CFrame.new(-737.943237, 74.9859161, 34.4008484, 0.52490741, -0.0237223599, 0.850828588, -0.00857717544, 0.999413371, 0.0331566781, -0.851116061, -0.0247018971, 0.524396002)
}
local currentPositionIndex = 1

-- Hàm bay liên tục đến vị trí hiện tại
local function flyToCurrentPosition()
    local currentDestination = positions[currentPositionIndex]

    -- Đảm bảo rằng không có vòng lặp bay trước đó còn hoạt động
    isFlying = false
    wait(1)  -- Tạm dừng ngắn để chắc chắn ngắt kết nối các vòng lặp cũ
    isFlying = true

    -- Liên tục bay đến vị trí hiện tại mà không có giới hạn thời gian
    while isFlying do
        if stopAfterMaxDeathsAtSecondPosition then
            warn("Script stopped after reaching max deaths at the second position.")
            return -- Dừng script sau khi chết 3 lần ở vị trí thứ 2
        end

        replicatedStorage.Remotes.CommF_:InvokeServer("EnablePvp")
        flyToPositionSmooth(currentDestination, 200)
        wait(0) -- Dừng lại trong 1 giây sau mỗi lần bay
    end
end

-- Hàm khi nhân vật chết
local function onPlayerDied()
    deathCount = deathCount + 1
    if deathCount >= maxDeaths then
        if currentPositionIndex == 1 then
            -- Nếu đang ở vị trí thứ nhất, chuyển sang vị trí thứ 2
            deathCount = 0  -- Reset lại bộ đếm
            currentPositionIndex = currentPositionIndex + 1
            flyToCurrentPosition()  -- Bắt đầu bay đến vị trí thứ 2
        elseif currentPositionIndex == 2 then
            -- Nếu đang ở vị trí thứ 2, dừng script
            stopAfterMaxDeathsAtSecondPosition = true
            isFlying = false  -- Dừng mọi vòng lặp bay
        end
    end
end

-- Kết nối sự kiện chết của nhân vật
player.CharacterAdded:Connect(function(character)
    local humanoid = character:WaitForChild("Humanoid")
    humanoid.Died:Connect(onPlayerDied)
end)

-- Thực hiện các hành động
SetTeam("Pirates")
wait(1)
TravelToDressrosa()

-- Bắt đầu bay liên tục đến vị trí đầu tiên cho đến khi chết 3 lần
flyToCurrentPosition()
